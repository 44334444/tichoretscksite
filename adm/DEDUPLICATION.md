# 📊 Система дедупликации по hostname

## 🎯 Как это работает

```
┌─────────────────────────────────────────────────────────┐
│                ПОСЕЩЕНИЕ САЙТА                          │
│  hostname: laptop.local                                 │
│  browser: Chrome 120                                    │
│  os: Windows 10                                         │
│  resolution: 1920x1080                                  │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
         ┌───────────────────────┐
         │  Проверка hostname    │
         └───────────┬───────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
         ▼                       ▼
    ЕСТЬ уже?              НЕТ новый?
         │                       │
    ┌────┴─────────────┐    ┌────┴──────────────────┐
    │                  │    │                       │
    ▼                  ▼    ▼                       ▼
ОБЪЕДИНЯЕМ      ОБНОВЛЯЕМ  СОЗДАЁМ          ИНИЦИАЛИЗИРУЕМ
посещение       профиль    новый             новый профиль
с существующим  пользователя профиль        пользователя
профилем
    │                  │
    └──────┬───────────┘
           │
           ▼
  ┌─────────────────────┐
  │  analytics.uniqueUsers
  │  {                  │
  │    "laptop.local": {│
  │      visitCount: 2  │
  │      browsers: {    │
  │        Chrome: 2    │
  │      }              │
  │      os: {          │
  │        Windows: 2   │
  │      }              │
  │    }                │
  │  }                  │
  └─────────────────────┘
```

## 📝 Пример данных

### Сценарий 1: Один пользователь, разные браузеры

```javascript
// Посещение 1: Chrome
{
  hostname: "laptop.local",
  browser: "Chrome 120",
  os: "Windows 10",
  resolution: "1920x1080"
}

// Посещение 2: Firefox (тот же пользователь)
{
  hostname: "laptop.local",
  browser: "Firefox 121",
  os: "Windows 10",
  resolution: "1920x1080"
}

// Результат в admin.js:
analytics.uniqueUsers["laptop.local"] = {
  hostname: "laptop.local",
  visitCount: 2,        // ✅ Оба посещения в один счетчик
  browsers: {
    "Chrome 120": 1,    // ✅ Разные браузеры отслеживаются
    "Firefox 121": 1
  },
  operatingSystems: {
    "Windows 10": 2     // ✅ Одна ОС, использована 2 раза
  },
  screenResolutions: {
    "1920x1080": 2      // ✅ Одно разрешение, использовано 2 раза
  }
}
```

### Сценарий 2: Разные пользователи

```javascript
// Посещение 1
hostname: "office.company.com"  → Новый профиль

// Посещение 2
hostname: "home.local"          → Другой профиль

// Результат:
analytics.uniqueUsers = {
  "office.company.com": { visitCount: 1, ... },
  "home.local": { visitCount: 1, ... }
}
```

## 🔍 Собираемые данные на одного пользователя (по hostname)

| Данные | Пример | Описание |
|--------|--------|---------|
| **hostname** | `laptop.local` | Имя компьютера в сети |
| **visitCount** | 5 | Всего посещений |
| **browsers** | `{ "Chrome 120": 3, "Firefox 121": 2 }` | Разные браузеры |
| **operatingSystems** | `{ "Windows 10": 4, "Windows 11": 1 }` | Разные ОС |
| **screenResolutions** | `{ "1920x1080": 5 }` | Разные разрешения |
| **pages** | `{ "/index.html": 3, "/gallery.html": 2 }` | Посещённые страницы |
| **firstVisit** | `10.01.2026 14:30:45` | Дата первого посещения |
| **lastVisit** | `11.01.2026 10:15:22` | Дата последнего посещения |

## 📊 Таблица в админ-панели

```
┌──────────────────┬──────────┬─────────────────────┬──────────────┬─────────────────┐
│ Hostname         │ Визитов  │ Браузеры            │ ОС           │ Первое - Послед. │
├──────────────────┼──────────┼─────────────────────┼──────────────┼─────────────────┤
│ laptop.local     │    5 ✓   │ Chrome 120 (3)      │ Windows 10 (5)│ 10.01 - 11.01   │
│                  │          │ Firefox 121 (2)     │              │                  │
├──────────────────┼──────────┼─────────────────────┼──────────────┼─────────────────┤
│ office.company   │    3 ✓   │ Edge 120 (3)        │ Windows 11 (3)│ 10.01 - 11.01   │
├──────────────────┼──────────┼─────────────────────┼──────────────┼─────────────────┤
│ home.local       │    2 ✓   │ Safari 17 (2)       │ macOS (2)     │ 11.01 - 11.01   │
└──────────────────┴──────────┴─────────────────────┴──────────────┴─────────────────┘
```

## ✅ Статистика в админ-панели

```
┌─────────────────┬─────────┐
│ Всего посещений │   10    │  (все посещения)
│ Посещений сегодня│   5    │  (за текущий день)
│ Уникальные люди │   3    │  ← ДЕДУПЛИКАЦИЯ (по hostname)
│ Уникальные браузеры │ 4  │
│ Уникальные ОС   │   2     │
└─────────────────┴─────────┘
```

## 🛠️ Код дедупликации

Находится в `adm/admin.js`, функция `trackVisit()`:

```javascript
// Если hostname уже существует - объединяем данные
if (analytics.uniqueUsers[hostname]) {
  // Увеличиваем счетчик
  // Обновляем браузеры
  // Обновляем ОС
  // Обновляем разрешения
  // Обновляем страницы
} else {
  // Создаём новый профиль пользователя
}
```

## 🔐 Безопасность

- ⚠️ **hostname** видна в браузере как `window.location.hostname`
- ℹ️ Это имя компьютера или домен
- ✅ Не содержит IP адреса пользователя
- ✅ Не содержит личные данные

## 🚀 Результаты

✅ **Дубликатов больше НЕТ**
- Один пользователь = один профиль (по hostname)
- Все браузеры объединяются в одном профиле
- Разные ОС отслеживаются но связаны с одним пользователем
- История посещений полная и логичная

---

**Статус**: ✅ Полностью реализовано и работает
