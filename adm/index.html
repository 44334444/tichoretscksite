<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель - Тихорецк</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="admin-container">
        <!-- Заголовок админки -->
        <div class="admin-header">
            <div>
                <h1><i class="fas fa-chart-line"></i> Панель управления</h1>
                <p class="text-muted mb-0">Аналитика и статистика сайта Тихорецк</p>
            </div>
            <a href="#" onclick="logout()" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i> Выход
            </a>
        </div>
        
        <!-- Основная статистика -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Всего посещений</h5>
                        <div class="stats-value" id="totalVisits">0</div>
                        <p class="text-muted small mb-0">С начала отслеживания</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Посещений сегодня</h5>
                        <div class="stats-value" id="todayVisits">0</div>
                        <p class="text-muted small mb-0" id="todayDate"></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Уникальные пользователи</h5>
                        <div class="stats-value" id="uniqueUsers">0</div>
                        <p class="text-muted small mb-0">По hostname</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Уникальные источники</h5>
                        <div class="stats-value" id="uniqueSources">0</div>
                        <p class="text-muted small mb-0">Источники трафика</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Отслеживаемые страницы</h5>
                        <div class="stats-value" id="trackedPages">0</div>
                        <p class="text-muted small mb-0">Уникальные страницы</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Графики -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-calendar-alt"></i> Посещения по дням</h5>
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class=\"fas fa-link\"></i> Источники трафика</h5>
                        <canvas id="sourcesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Таблицы статистики -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-server"></i> Популярные страницы</h5>
                        <table class="table" id="pagesTable">
                            <thead>
                                <tr>
                                    <th>Страница</th>
                                    <th>Посещений</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Данные будут заполнены JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-globe"></i> Источники трафика</h5>
                        <table class="table" id="sourcesTable">
                            <thead>
                                <tr>
                                    <th>Источник</th>
                                    <th>Посещений</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Данные будут заполнены JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
                        <table class="table" id="devicesTable">
                            <thead>
                                <tr>
                                    <th>ОС</th>
                                    <th>Посещений</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Данные будут заполнены JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-firefox"></i> Браузеры</h5>
                        <table class="table" id="browsersTable">
                            <thead>
                                <tr>
                                    <th>Браузер</th>
                                    <th>Посещений</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Данные будут заполнены JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Разрешения экрана и последние посещения -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-tv"></i> Разрешения экрана</h5>
                        <table class="table" id="resolutionsTable">
                            <thead>
                                <tr>
                                    <th>Разрешение</th>
                                    <th>Посещений</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Данные будут заполнены JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Уникальные пользователи (дедупликация по hostname) -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-users"></i> Уникальные пользователи (по hostname)</h5>
                        <p class="text-muted small mb-3">Система автоматически объединяет посещения одного пользователя по имени хоста. Разные браузеры и IP адреса отслеживаются отдельно.</p>
                        <div class="table-responsive">
                            <table class="table table-sm" id="uniqueUsersTable">
                                <thead>
                                    <tr>
                                        <th>Hostname</th>
                                        <th class="text-center">Посещений</th>
                                        <th>Браузеры</th>
                                        <th>ОС</th>
                                        <th>Страницы</th>
                                        <th>Первое</th>
                                        <th>Последнее</th>
                                        <th>Разрешения</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Данные будут заполнены JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Последние посещения -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-history"></i> Последние посещения (20)</h5>
                        <div class="table-responsive">
                            <table class="table table-sm" id="lastVisitsTable">
                                <thead>
                                    <tr>
                                        <th>Время</th>
                                        <th>ОС</th>
                                        <th>Браузер</th>
                                        <th>Разрешение</th>
                                        <th>Страница</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Данные будут заполнены JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Кнопки действий -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-cog"></i> Действия</h5>
                        <button class="btn btn-danger me-2" onclick="clearAnalytics()">
                            <i class="fas fa-trash"></i> Очистить аналитику
                        </button>
                        <button class="btn btn-info" onclick="exportData()">
                            <i class="fas fa-download"></i> Экспортировать данные
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="admin.js"></script>
    <script>
        // Проверка аутентификации
        function checkAuthentication() {
            const sessionData = localStorage.getItem('adminSession');
            
            if (!sessionData) {
                // Редирект на страницу входа
                window.location.href = 'login.html';
                return false;
            }
            
            try {
                const session = JSON.parse(sessionData);
                
                // Проверяем, не истекла ли сессия
                if (Date.now() > session.expires) {
                    localStorage.removeItem('adminSession');
                    window.location.href = 'login.html';
                    return false;
                }
                
                return true;
            } catch (e) {
                window.location.href = 'login.html';
                return false;
            }
        }
        
        // Выход из системы
        function logout() {
            if (confirm('Вы уверены? Вы выйдете из админ-панели.')) {
                localStorage.removeItem('adminSession');
                window.location.href = 'login.html';
            }
        }
        
        // Очистить аналитику
        function clearAnalytics() {
            if (confirm('Все данные аналитики будут удалены. Это действие необратимо!')) {
                localStorage.removeItem('siteAnalytics');
                location.reload();
            }
        }
        
        // Экспортировать данные
        function exportData() {
            const analytics = localStorage.getItem('siteAnalytics');
            const dataStr = analytics || '{}';
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `tikhoretsk_analytics_${new Date().toISOString().slice(0, 10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        // Проверяем аутентификацию при загрузке
        window.addEventListener('load', function() {
            checkAuthentication();
        });
    </script>
</body>
</html>